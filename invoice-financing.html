<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Invoice Financing - TradeBridge</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="invoice-financing.css">
    <script src="sidebar-toggle.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="dashboard-body">
    <!-- Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <a href="index.html" class="logo">
                <div class="logo-icon">
                    <span class="logo-text-small">TB</span>
                </div>
                <span class="logo-text">TradeBridge</span>
            </a>
            <div class="header-actions">
                
                <!-- Language Dropdown -->
                <div class="dropdown-container">
                    <button class="dropdown-trigger" onclick="toggleLanguageDropdown()">
                        <div class="worldwide-icon">üåç</div>
                        <span>EN</span>
                        <img src="icons/chevron-down.svg" alt="Dropdown" width="16" height="16">
                    </button>
                    <div class="dropdown-menu" id="languageDropdown">
                        <div class="dropdown-item" onclick="selectLanguage('en')">
                            <span>English</span>
                            <img src="icons/check.svg" alt="Selected" width="16" height="16" class="check-icon">
                        </div>
                        <div class="dropdown-item" onclick="selectLanguage('es')">
                            <span>Espa√±ol</span>
                        </div>
                        <div class="dropdown-item" onclick="selectLanguage('fr')">
                            <span>Fran√ßais</span>
                        </div>
                    </div>
                </div>
                
                <!-- User Profile Dropdown -->
                <div class="dropdown-container">
                    <button class="dropdown-trigger" onclick="toggleUserDropdown()">
                        <div class="user-avatar">JD</div>
                        <span class="user-name">John Doe</span>
                        <img src="icons/chevron-down.svg" alt="Dropdown" width="16" height="16">
                    </button>
                    <div class="dropdown-menu" id="userDropdown">
                        <div class="dropdown-item" onclick="navigateToPage('profile')">
                            <img src="icons/user.svg" alt="Profile" width="16" height="16">
                            <span>Profile</span>
                        </div>
                        <div class="dropdown-item" onclick="navigateToPage('settings')">
                            <div class="settings-icon-small">‚öôÔ∏è</div>
                            <span>Settings</span>
                        </div>
                        <div class="dropdown-divider"></div>
                        <div class="dropdown-item logout" onclick="logout()">
                            <img src="icons/logout.svg" alt="Logout" width="16" height="16">
                            <span>Logout</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="dashboard-sidebar">
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <div class="nav-icon">
                        <div class="dashboard-icon">üìä</div>
                    </div>
                    <span>Dashboard</span>
                </a>
                <a href="trade-agreement.html" class="nav-item">
                    <div class="nav-icon">
                        <div class="trade-agreement-icon">ü§ù</div>
                    </div>
                    <span>Trade Agreements</span>
                </a>
                <a href="invoice-financing.html" class="nav-item active">
                    <div class="nav-icon">
                        <div class="invoice-financing-icon">üßæ</div>
                    </div>
                    <span>Invoice Financing</span>
                    <div class="nav-arrow">
                        <img src="icons/chevron-right.svg" alt="Arrow" width="16" height="16">
                    </div>
                </a>
                <a href="wallet.html" class="nav-item">
                    <div class="nav-icon">
                        <div class="wallet-icon">üëõ</div>
                    </div>
                    <span>Wallet</span>
                </a>
                <a href="shipment-tracker.html" class="nav-item">
                    <div class="nav-icon">
                        <div class="shipment-tracker-icon">üöö</div>
                    </div>
                    <span>Shipment Tracker <span class="nav-badge-text">(3)</span></span>
                </a>
                <a href="notifications.html" class="nav-item">
                    <div class="nav-icon">
                        <div class="notifications-icon">üì¢</div>
                    </div>
                    <span>Notifications <span class="nav-badge-text">(5)</span></span>
                </a>
                <a href="settings.html" class="nav-item">
                    <div class="nav-icon">
                        <div class="settings-icon">‚öôÔ∏è</div>
                    </div>
                    <span>Settings</span>
                </a>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="page-header">
                <div class="header-text">
                    <h1>Invoice Financing</h1>
                    <p>Get instant financing for your trade invoices using DeFi pools</p>
                </div>
                <div class="header-actions">
                    <button class="btn btn-outline" onclick="refreshData()">
                        <img src="icons/refresh.svg" alt="Refresh" width="16" height="16">
                        Refresh
                    </button>
                </div>
            </div>

            <div class="invoice-grid">
                <!-- Main Content Area -->
                <div class="main-content-area">
                    <!-- Upload Section -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <img src="icons/upload.svg" alt="Upload" width="20" height="20">
                                Invoice Upload
                            </h2>
                        </div>
                        <div class="card-content">
                            <!-- Upload Tabs -->
                            <div class="upload-tabs">
                                <button class="upload-tab active" onclick="switchUploadTab('drag')" id="dragTab">
                                    <img src="icons/upload.svg" alt="Drag" width="16" height="16">
                                    Drag & Drop
                                </button>
                                <button class="upload-tab" onclick="switchUploadTab('browse')" id="browseTab">
                                    <img src="icons/file-text.svg" alt="Browse" width="16" height="16">
                                    Browse Files
                                </button>
                            </div>
                            
                            <!-- Upload Area -->
                            <div class="upload-area" id="uploadArea">
                                <input type="file" id="fileUpload" class="file-input" accept=".pdf,.jpg,.png,.jpeg" onchange="handleFileUpload(event)" multiple>
                                
                                <!-- Drag & Drop Tab Content -->
                                <div class="upload-content" id="dragContent">
                                    <label for="fileUpload" class="upload-label">
                                        <div class="upload-icon">
                                            <img src="icons/upload-large.svg" alt="Upload" width="48" height="48">
                                        </div>
                                        <div class="upload-text">
                                            <p class="upload-title" id="uploadTitle">Drag & drop your invoice here</p>
                                            <p class="upload-subtitle">PDF, JPG, PNG or JPEG up to 10MB each</p>
                                        </div>
                                    </label>
                                </div>
                                
                                <!-- Browse Files Tab Content -->
                                <div class="upload-content" id="browseContent" style="display: none;">
                                    <div class="browse-content">
                                        <div class="browse-icon">
                                            <img src="icons/file-text.svg" alt="Browse" width="48" height="48">
                                        </div>
                                        <div class="browse-text">
                                            <p class="browse-title">Select Invoice Files</p>
                                            <p class="browse-subtitle">Choose PDF, JPG, PNG or JPEG files from your device</p>
                                        </div>
                                        <button type="button" class="btn btn-primary" onclick="document.getElementById('fileUpload').click()">
                                            <img src="icons/file-text.svg" alt="Browse" width="16" height="16">
                                            Choose Files
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- File Preview Area -->
                                <div class="file-preview" id="filePreview" style="display: none;">
                                    <div class="preview-header">
                                        <h4>Selected Files</h4>
                                        <button type="button" class="btn btn-sm btn-outline" onclick="clearFiles()">Clear All</button>
                                    </div>
                                    <div class="preview-list" id="previewList"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Details -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">
                                <img src="icons/file-text.svg" alt="Invoice" width="20" height="20">
                                Invoice Details
                            </h2>
                            <div class="extraction-status" id="extractionStatus" style="display: none;">
                                <div class="status-indicator">
                                    <div class="status-icon">ü§ñ</div>
                                    <span class="status-text">AI Extraction Complete</span>
                                </div>
                            </div>
                        </div>
                        <div class="card-content">
                            <!-- Auto-extracted Data Display -->
                            <div class="extracted-data" id="extractedData" style="display: none;">
                                <div class="extraction-summary">
                                    <h4>Extracted Information</h4>
                                    <div class="extraction-items">
                                        <div class="extraction-item">
                                            <span class="item-label">Invoice Number:</span>
                                            <span class="item-value" id="extractedInvoiceNumber">INV-2024-001</span>
                                        </div>
                                        <div class="extraction-item">
                                            <span class="item-label">Total Amount:</span>
                                            <span class="item-value" id="extractedAmount">$75,000.00</span>
                                        </div>
                                        <div class="extraction-item">
                                            <span class="item-label">Due Date:</span>
                                            <span class="item-value" id="extractedDueDate">2024-12-15</span>
                                        </div>
                                        <div class="extraction-item">
                                            <span class="item-label">Buyer:</span>
                                            <span class="item-value" id="extractedBuyer">Global Trade Corp</span>
                                        </div>
                                        <div class="extraction-item">
                                            <span class="item-label">Seller:</span>
                                            <span class="item-value" id="extractedSeller">Tech Solutions Ltd</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Manual Input Form -->
                            <div class="form-grid">
                                <div class="form-group">
                                    <label for="amount">Invoice Amount</label>
                                    <div class="input-wrapper">
                                        <span class="input-prefix">$</span>
                                        <input type="number" id="amount" placeholder="e.g., 50000" oninput="updateFinancingTerms()">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="dueDate">Due Date</label>
                                    <input type="date" id="dueDate" onchange="updateFinancingTerms()">
                                </div>
                            </div>
                            <div class="form-group">
                                <label>Customer Information</label>
                                <div class="form-grid">
                                    <input type="text" placeholder="Customer Name" id="customerName">
                                    <input type="text" placeholder="Customer Address" id="customerAddress">
                                </div>
                            </div>

                            <!-- Smart Contract Generation -->
                            <div class="smart-contract-section" id="smartContractSection" style="display: none;">
                                <div class="contract-header">
                                    <h4>Smart Contract Generation</h4>
                                    <button type="button" class="btn btn-primary" onclick="generateSmartContract()">
                                        <img src="icons/smart-contracts.svg" alt="Generate" width="16" height="16">
                                        Generate Contract
                                    </button>
                                </div>
                                <div class="contract-preview" id="contractPreview" style="display: none;">
                                    <div class="contract-details">
                                        <h5>Trade Agreement Preview</h5>
                                        <div class="contract-info">
                                            <div class="contract-item">
                                                <span class="contract-label">Agreement ID:</span>
                                                <span class="contract-value" id="contractId">TA-2024-001</span>
                                            </div>
                                            <div class="contract-item">
                                                <span class="contract-label">Amount:</span>
                                                <span class="contract-value" id="contractAmount">$75,000.00</span>
                                            </div>
                                            <div class="contract-item">
                                                <span class="contract-label">Payment Terms:</span>
                                                <span class="contract-value" id="contractTerms">Net 30 days</span>
                                            </div>
                                            <div class="contract-item">
                                                <span class="contract-label">Status:</span>
                                                <span class="contract-value contract-status">Ready for Download</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="contract-actions">
                                        <button type="button" class="btn btn-outline" onclick="downloadContract('pdf')">
                                            <img src="icons/file-text.svg" alt="PDF" width="16" height="16">
                                            Download PDF
                                        </button>
                                        <button type="button" class="btn btn-outline" onclick="downloadContract('json')">
                                            <img src="icons/file-text.svg" alt="JSON" width="16" height="16">
                                            Download JSON
                                        </button>
                                        <button type="button" class="btn btn-primary" onclick="deployContract()">
                                            <img src="icons/smart-contracts.svg" alt="Deploy" width="16" height="16">
                                            Deploy to Blockchain
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- AI Risk Assessment -->
                    <div class="card" id="riskAssessmentCard" style="display: none;">
                        <div class="card-header">
                            <h2 class="card-title">
                                <img src="icons/shield.svg" alt="Shield" width="20" height="20">
                                AI Risk Assessment
                            </h2>
                        </div>
                        <div class="card-content">
                            <div class="risk-score-section">
                                <div class="risk-score-header">
                                    <span class="risk-label">Risk Score</span>
                                    <span class="risk-value" id="riskValue">75/100 - Low Risk</span>
                                </div>
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill" style="width: 75%"></div>
                                </div>
                            </div>

                            <div class="risk-factors">
                                <div class="risk-factor">
                                    <div class="factor-icon green">
                                        <img src="icons/trending-up.svg" alt="Trending Up" width="24" height="24">
                                    </div>
                                    <div class="factor-content">
                                        <p class="factor-label">Payment History</p>
                                        <p class="factor-value">Excellent</p>
                                    </div>
                                </div>
                                <div class="risk-factor">
                                    <div class="factor-icon blue">
                                        <img src="icons/shield.svg" alt="Shield" width="24" height="24">
                                    </div>
                                    <div class="factor-content">
                                        <p class="factor-label">Credit Rating</p>
                                        <p class="factor-value">A+</p>
                                    </div>
                                </div>
                                <div class="risk-factor">
                                    <div class="factor-icon yellow">
                                        <img src="icons/alert-triangle.svg" alt="Alert" width="24" height="24">
                                    </div>
                                    <div class="factor-content">
                                        <p class="factor-label">Industry Risk</p>
                                        <p class="factor-value">Low</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <div class="sidebar-content">
                    <!-- Financing Terms -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Financing Terms</h2>
                        </div>
                        <div class="card-content">
                            <div class="terms-list">
                                <div class="term-item">
                                    <span class="term-label">Financing Amount:</span>
                                    <span class="term-value" id="financingAmount">$0</span>
                                </div>
                                <div class="term-item">
                                    <span class="term-label">Advance Rate:</span>
                                    <span class="term-value">85%</span>
                                </div>
                                <div class="term-item">
                                    <span class="term-label">Estimated APR:</span>
                                    <span class="term-value" id="estimatedAPR">12.5%</span>
                                </div>
                                <div class="term-item">
                                    <span class="term-label">Processing Fee:</span>
                                    <span class="term-value">2.5%</span>
                                </div>
                                <div class="term-item">
                                    <span class="term-label">Funding Time:</span>
                                    <span class="term-value">24-48 hours</span>
                                </div>
                            </div>
                            <div class="terms-divider"></div>
                            <div class="term-item highlight">
                                <span class="term-label">You Receive:</span>
                                <span class="term-value green" id="youReceive">$0</span>
                            </div>
                        </div>
                    </div>

                    <!-- DeFi Pool Info -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">DeFi Pool Info</h2>
                        </div>
                        <div class="card-content">
                            <div class="pool-stats">
                                <div class="pool-stat">
                                    <span class="stat-label">Pool TVL:</span>
                                    <span class="stat-value">$12.4M</span>
                                </div>
                                <div class="pool-stat">
                                    <span class="stat-label">Available Liquidity:</span>
                                    <span class="stat-value">$8.9M</span>
                                </div>
                                <div class="pool-stat">
                                    <span class="stat-label">Pool Utilization:</span>
                                    <span class="stat-value">72%</span>
                                </div>
                                <div class="pool-stat">
                                    <span class="stat-label">Average Pool APY:</span>
                                    <span class="stat-value">15.2%</span>
                                </div>
                            </div>
                            <div class="insurance-badge">
                                <img src="icons/shield.svg" alt="Shield" width="16" height="16">
                                <span>Insurance Protected</span>
                            </div>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Actions</h2>
                        </div>
                        <div class="card-content">
                            <button class="btn btn-primary btn-full" id="submitBtn" onclick="openConfirmationModal()" disabled>
                                Submit to DeFi Pool
                            </button>
                            <button class="btn btn-outline btn-full" onclick="viewTerms()">
                                View Terms & Conditions
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal" id="confirmationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Financing Request</h2>
                <span class="close" onclick="closeConfirmationModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p class="modal-description">Please review and confirm the details of your financing request before submitting to the DeFi pool.</p>
                <div class="confirmation-details">
                    <div class="detail-item">
                        <span class="detail-label">Invoice Amount:</span>
                        <span class="detail-value" id="confirmAmount">$0</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">You'll Receive:</span>
                        <span class="detail-value green" id="confirmReceive">$0</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">APR:</span>
                        <span class="detail-value" id="confirmAPR">0%</span>
                    </div>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="confirmSubmission()">Confirm</button>
                    <button class="btn btn-outline" onclick="closeConfirmationModal()">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- User Data Manager -->
    <script src="user-data-manager.js"></script>

    <script>
        // State management
        let uploadedFiles = [];
        let riskScore = 75;
        let estimatedAPR = 12.5;

        // Navigation functions
        function navigateToPage(page) {
            window.location.href = page + '.html';
        }

        function refreshData() {
            console.log('Refreshing data...');
        }

        function toggleNotifications() {
            console.log('Toggle notifications');
        }

        // Dropdown functionality
        function toggleLanguageDropdown() {
            const dropdown = document.getElementById('languageDropdown');
            const userDropdown = document.getElementById('userDropdown');
            
            userDropdown.classList.remove('show');
            dropdown.classList.toggle('show');
        }

        function toggleUserDropdown() {
            const dropdown = document.getElementById('userDropdown');
            const languageDropdown = document.getElementById('languageDropdown');
            
            languageDropdown.classList.remove('show');
            dropdown.classList.toggle('show');
        }

        function selectLanguage(lang) {
            const languageSpan = document.querySelector('.dropdown-trigger span');
            const languageMap = {
                'en': 'EN',
                'es': 'ES',
                'fr': 'FR'
            };
            
            languageSpan.textContent = languageMap[lang];
            document.getElementById('languageDropdown').classList.remove('show');
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                window.location.href = 'index.html';
            }
        }

        // Upload tab switching
        function switchUploadTab(tab) {
            const dragTab = document.getElementById('dragTab');
            const browseTab = document.getElementById('browseTab');
            const dragContent = document.getElementById('dragContent');
            const browseContent = document.getElementById('browseContent');
            
            if (tab === 'drag') {
                dragTab.classList.add('active');
                browseTab.classList.remove('active');
                dragContent.style.display = 'block';
                browseContent.style.display = 'none';
            } else {
                browseTab.classList.add('active');
                dragTab.classList.remove('active');
                browseContent.style.display = 'block';
                dragContent.style.display = 'none';
            }
        }

        // File upload handling with multiple files support
        function handleFileUpload(event) {
            const files = event.target.files;
            if (files && files.length > 0) {
                uploadedFiles = Array.from(files);
                showFilePreview(uploadedFiles);
                
                // Simulate AI invoice data extraction
                simulateInvoiceExtraction();
                
                // Simulate AI risk assessment for the first file
                simulateRiskAssessment();
                
                // Show risk assessment card
                document.getElementById('riskAssessmentCard').style.display = 'block';
                
                // Enable submit button if amount is filled
                updateSubmitButton();
            }
        }

        // Simulate AI invoice data extraction
        function simulateInvoiceExtraction() {
            // Show extraction status
            const extractionStatus = document.getElementById('extractionStatus');
            const extractedData = document.getElementById('extractedData');
            const smartContractSection = document.getElementById('smartContractSection');
            
            // Simulate processing delay
            setTimeout(() => {
                extractionStatus.style.display = 'block';
                extractedData.style.display = 'block';
                smartContractSection.style.display = 'block';
                
                // Auto-populate form fields with extracted data
                populateFormWithExtractedData();
                
                // Show success message
                showToast('Invoice data extracted successfully!', 'success');
            }, 2000);
        }

        // Populate form with extracted data
        function populateFormWithExtractedData() {
            const extractedAmount = document.getElementById('extractedAmount').textContent;
            const extractedDueDate = document.getElementById('extractedDueDate').textContent;
            const extractedBuyer = document.getElementById('extractedBuyer').textContent;
            
            // Populate form fields
            document.getElementById('amount').value = extractedAmount.replace('$', '').replace(',', '');
            document.getElementById('dueDate').value = extractedDueDate;
            document.getElementById('customerName').value = extractedBuyer;
            
            // Update financing terms
            updateFinancingTerms();
        }

        // Generate smart contract
        function generateSmartContract() {
            const contractPreview = document.getElementById('contractPreview');
            const contractId = document.getElementById('contractId');
            const contractAmount = document.getElementById('contractAmount');
            const contractTerms = document.getElementById('contractTerms');
            
            // Generate unique contract ID
            const uniqueId = 'TA-' + Date.now().toString().slice(-6);
            contractId.textContent = uniqueId;
            
            // Set contract details
            contractAmount.textContent = document.getElementById('extractedAmount').textContent;
            contractTerms.textContent = 'Net 30 days';
            
            // Show contract preview
            contractPreview.style.display = 'block';
            
            // Show success message
            showToast('Smart contract generated successfully!', 'success');
        }

        // Download contract
        function downloadContract(format) {
            const contractData = {
                id: document.getElementById('contractId').textContent,
                amount: document.getElementById('contractAmount').textContent,
                terms: document.getElementById('contractTerms').textContent,
                buyer: document.getElementById('extractedBuyer').textContent,
                seller: document.getElementById('extractedSeller').textContent,
                dueDate: document.getElementById('extractedDueDate').textContent,
                invoiceNumber: document.getElementById('extractedInvoiceNumber').textContent,
                generatedAt: new Date().toISOString(),
                status: 'Ready for Execution'
            };

            if (format === 'pdf') {
                downloadPDFContract(contractData);
            } else if (format === 'json') {
                downloadJSONContract(contractData);
            }
        }

        // Download PDF contract
        function downloadPDFContract(data) {
            // Create a simple PDF-like content
            const content = `
                TRADE AGREEMENT
                ================
                
                Agreement ID: ${data.id}
                Generated: ${new Date().toLocaleDateString()}
                
                PARTIES:
                Buyer: ${data.buyer}
                Seller: ${data.seller}
                
                TERMS:
                Amount: ${data.amount}
                Payment Terms: ${data.terms}
                Due Date: ${data.dueDate}
                Invoice Number: ${data.invoiceNumber}
                
                STATUS: ${data.status}
                
                This agreement is generated by TradeBridge's AI system
                and is ready for blockchain deployment.
            `;
            
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${data.id}-Trade-Agreement.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Trade agreement downloaded!', 'success');
        }

        // Download JSON contract
        function downloadJSONContract(data) {
            const jsonContent = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonContent], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${data.id}-Contract.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('Contract JSON downloaded!', 'success');
        }

        // Deploy contract to blockchain
        function deployContract() {
            const contractId = document.getElementById('contractId').textContent;
            
            // Simulate blockchain deployment
            showToast('Deploying contract to blockchain...', 'info');
            
            setTimeout(() => {
                showToast(`Contract ${contractId} deployed successfully!`, 'success');
                
                // Update contract status
                const statusElement = document.querySelector('.contract-status');
                statusElement.textContent = 'Deployed to Blockchain';
                statusElement.style.color = '#10B981';
            }, 3000);
        }

        // Show toast notification
        function showToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 12px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                ${type === 'success' ? 'background: #10B981;' : 
                  type === 'error' ? 'background: #EF4444;' : 
                  'background: #3B82F6;'}
            `;

            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);

            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // Show file preview
        function showFilePreview(files) {
            const filePreview = document.getElementById('filePreview');
            const previewList = document.getElementById('previewList');
            
            filePreview.style.display = 'block';
            previewList.innerHTML = '';
            
            files.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon">
                            ${getFileIcon(file.type)}
                        </div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                        </div>
                    </div>
                    <div class="file-actions">
                        <button type="button" class="btn btn-sm btn-outline" onclick="removeFile(${index})">Remove</button>
                    </div>
                `;
                previewList.appendChild(fileItem);
            });
        }

        // Get file icon based on type
        function getFileIcon(fileType) {
            if (fileType === 'application/pdf') {
                return '<img src="icons/file-text.svg" alt="PDF" width="20" height="20">';
            } else if (fileType.startsWith('image/')) {
                return '<img src="icons/image.svg" alt="Image" width="20" height="20">';
            } else {
                return '<img src="icons/file-text.svg" alt="File" width="20" height="20">';
            }
        }

        // Format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Remove individual file
        function removeFile(index) {
            uploadedFiles.splice(index, 1);
            if (uploadedFiles.length === 0) {
                document.getElementById('filePreview').style.display = 'none';
                document.getElementById('fileUpload').value = '';
            } else {
                showFilePreview(uploadedFiles);
            }
        }

        // Clear all files
        function clearFiles() {
            uploadedFiles = [];
            document.getElementById('filePreview').style.display = 'none';
            document.getElementById('fileUpload').value = '';
        }

        function simulateRiskAssessment() {
            // Simulate random risk score between 60-90
            riskScore = Math.floor(Math.random() * 30) + 60;
            estimatedAPR = riskScore >= 70 ? 8.5 : riskScore >= 40 ? 12.5 : 18.0;
            
            updateRiskDisplay();
            updateFinancingTerms();
        }

        function updateRiskDisplay() {
            const riskValue = document.getElementById('riskValue');
            const progressFill = document.getElementById('progressFill');
            
            let riskLabel = 'Low Risk';
            let riskColor = 'green';
            
            if (riskScore >= 70) {
                riskLabel = 'Low Risk';
                riskColor = 'green';
            } else if (riskScore >= 40) {
                riskLabel = 'Medium Risk';
                riskColor = 'yellow';
            } else {
                riskLabel = 'High Risk';
                riskColor = 'red';
            }
            
            riskValue.textContent = `${riskScore}/100 - ${riskLabel}`;
            riskValue.className = `risk-value ${riskColor}`;
            progressFill.style.width = `${riskScore}%`;
            progressFill.className = `progress-fill ${riskColor}`;
        }

        function updateFinancingTerms() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const financingAmount = amount * 0.85;
            const processingFee = financingAmount * 0.025;
            const youReceive = financingAmount - processingFee;
            
            document.getElementById('financingAmount').textContent = `$${financingAmount.toLocaleString()}`;
            document.getElementById('estimatedAPR').textContent = `${estimatedAPR}%`;
            document.getElementById('youReceive').textContent = `$${youReceive.toLocaleString()}`;
            
            updateSubmitButton();
        }

        function updateSubmitButton() {
            const amount = document.getElementById('amount').value;
            const submitBtn = document.getElementById('submitBtn');
            
            if (uploadedFile && amount) {
                submitBtn.disabled = false;
            } else {
                submitBtn.disabled = true;
            }
        }

        function openConfirmationModal() {
            const amount = parseFloat(document.getElementById('amount').value) || 0;
            const financingAmount = amount * 0.85;
            const processingFee = financingAmount * 0.025;
            const youReceive = financingAmount - processingFee;
            
            document.getElementById('confirmAmount').textContent = `$${amount.toLocaleString()}`;
            document.getElementById('confirmReceive').textContent = `$${youReceive.toLocaleString()}`;
            document.getElementById('confirmAPR').textContent = `${estimatedAPR}%`;
            
            document.getElementById('confirmationModal').style.display = 'block';
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').style.display = 'none';
        }

        function confirmSubmission() {
            alert('Financing request submitted successfully! You will receive funds within 24-48 hours.');
            closeConfirmationModal();
        }

        function viewTerms() {
            alert('Terms & Conditions would open here');
        }

        // Close modals when clicking outside
        window.onclick = function(event) {
            const modals = document.querySelectorAll('.modal');
            modals.forEach(modal => {
                if (event.target === modal) {
                    modal.style.display = 'none';
                }
            });
            
            const languageDropdown = document.getElementById('languageDropdown');
            const userDropdown = document.getElementById('userDropdown');
            
            if (!event.target.closest('.dropdown-container')) {
                languageDropdown.classList.remove('show');
                userDropdown.classList.remove('show');
            }
        }

        // Drag and drop functionality
        const uploadArea = document.getElementById('uploadArea');
        
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        
        uploadArea.addEventListener('dragleave', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');

            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const fileInput = document.getElementById('fileUpload');
                fileInput.files = files;
                handleFileUpload({ target: { files: files } });
            }
        });

        // Initialize user profile from stored data
        function initializeUserProfile() {
            if (window.userDataManager && window.userDataManager.hasCompletedSignup()) {
                const userData = window.userDataManager.getAllUserData();
                const personalInfo = userData.personalInfo;
                
                // Update header user info
                const userAvatar = document.querySelector('.user-avatar');
                const userName = document.querySelector('.user-name');
                
                if (userAvatar && personalInfo.initials) {
                    userAvatar.textContent = personalInfo.initials;
                }
                
                if (userName && personalInfo.fullName) {
                    userName.textContent = personalInfo.fullName;
                }
            }
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeUserProfile();
        });
    </script>
</body>
</html>